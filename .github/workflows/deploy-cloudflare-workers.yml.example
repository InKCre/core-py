# GitHub Actions Workflow for Cloudflare Workers Deployment
# 
# This workflow deploys InKCre Core to Cloudflare Workers on push to main branch.
# 
# Setup Required:
# 1. Add CLOUDFLARE_API_TOKEN to repository secrets
#    - Go to: Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
#    - Get token from: https://dash.cloudflare.com/profile/api-tokens
#    - Required permissions: Workers Scripts (Edit)
# 
# 2. Add CLOUDFLARE_ACCOUNT_ID to repository secrets
#    - Find in Cloudflare dashboard URL or Workers overview page
#
# 3. Ensure all Worker secrets are set via Wrangler CLI before first deployment
#    - DB_CONN_STRING
#    - CF_WORKER
#    - OPENAI_API_KEY (if needed)
#    - etc.

name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main  # Deploy on push to main branch
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Prepare Workers dependencies
        run: |
          # Use Workers-optimized requirements
          cp requirements-worker.txt requirements.txt
          echo "âœ“ Using Workers-optimized requirements"

      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          wrangler deploy
          echo "âœ“ Deployment successful"

      - name: Verify deployment
        run: |
          # Wait a few seconds for deployment to propagate
          sleep 5
          
          # Get the deployed URL from wrangler.toml
          WORKER_NAME=$(grep "^name = " wrangler.toml | cut -d'"' -f2)
          WORKER_URL="https://${WORKER_NAME}.workers.dev"
          
          echo "Testing deployment at: $WORKER_URL/heartbeat"
          
          # Test health check endpoint
          RESPONSE=$(curl -s "${WORKER_URL}/heartbeat" || echo "")
          
          if echo "$RESPONSE" | grep -q "ok"; then
            echo "âœ“ Health check passed"
            echo "Response: $RESPONSE"
          else
            echo "âœ— Health check failed"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: Deployment summary
        if: success()
        run: |
          WORKER_NAME=$(grep "^name = " wrangler.toml | cut -d'"' -f2)
          echo "ðŸŽ‰ Deployment successful!"
          echo "Worker URL: https://${WORKER_NAME}.workers.dev"
          echo ""
          echo "Next steps:"
          echo "1. Verify all API endpoints are working"
          echo "2. Check Cloudflare dashboard for logs and metrics"
          echo "3. Set up Cron Triggers for scheduled tasks (if not already configured)"
